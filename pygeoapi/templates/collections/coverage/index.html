{% extends "_base.html" %}
{% block title %}{{ super() }} {{ data['title'] }} {% endblock %}
{% block crumbs %}{{ super() }}
/ <a href="{{ data['collections_path'] }}">{% trans %}Collections{% endtrans %}</a>
{% for link in data['links'] %}
  {% if link.rel == 'collection' %} /
    <a href="{{ data['dataset_path'] }}">{{ link['title'] | string | truncate( 25 ) }}</a>
    {% set col_title = link['title'] %}
  {% endif %}
{% endfor %}
/ <a href="{{ data['items_path']}}">{% trans %}Items{% endtrans %}</a>
{% endblock %}
{% block extrahead %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.imageoverlay.arrugator"></script>
    <script src="https://unpkg.com/proj4@2.8.0/dist/proj4-src.js"></script>
{% endblock %}

{% block body %}
  <section id="map"></section>
  <section id="collection">
      <h1>{{ data['title'] }}</h1>
      <p>{{ data['description'] }}</p>
  </section>
<div class="col-md-8">
	<div id="coverage-map"></div>
</div>
{% endblock %}

{% block extrafoot %}

    <script>
    const map = L.map('coverage-map').setView([0,0], 0);
    map.addLayer(new L.TileLayer(
        '{{ config['server']['map']['url'] }}', {
            maxZoom: 18,
            attribution: '{{ config['server']['map']['attribution'] | safe }}'
        }
    ));

    const bbox = {{ data.bbox | to_json | safe}};

    /// TODO: How to get the proj.4 string for this CRS???!!
    const crs = {{ data.crs | to_json | safe }};

    let subdivisions = 1;
    let cropX = [-Infinity, Infinity];
    let cropY = [-Infinity, Infinity];
    let proj4str = "";  /// FIXME!!!!

    // Work around known problematic transformations
    if (crs === "http://www.opengis.net/def/crs/OGC/1.3/CRS84") {
      subdivisions = 4;
      cropY = [-89,89];
      proj4str = "EPSG:4326";
    } else if (crs === "http://www.opengis.net/def/crs/OGC/1.3//25833"){
      subdivisions = 1;
      proj4str = "+proj=utm +zone=33 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs";
    }

  let arrugatedCoverage = L.imageOverlay.arrugator(
      "{{ data.collections_path }}/{{ data.id }}/coverage?f=PNG", {
      // "{{ data.collections_path }}/{{ data.id }}/coverage", {
          controlPoints: [
              [bbox[0], bbox[3]], // top-left
              [bbox[0], bbox[1]], // bottom-left
              [bbox[2], bbox[3]], // upper-right
              [bbox[2], bbox[1]], // lower-right
          ],
          projector: proj4(proj4str, "EPSG:3857").forward,

          // Means a max error of 1000 meters per raster px
          // TODO: calculate from raster metadata!
          epsilon: 1000000,
          subdivisions,
          cropX,
          cropY,
      })
      .addTo(map);

    map.fitBounds(arrugatedCoverage.getBounds());

    </script>
{% endblock %}
